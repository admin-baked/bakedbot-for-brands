name: ALWAYS ON - Pulse Heartbeat

on:
  schedule:
    # Run every 10 minutes - The heartbeat of the entire system
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  pulse:
    runs-on: ubuntu-latest
    steps:
      - name: Check CRON_SECRET
        run: |
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "ERROR: CRON_SECRET is not set"
            exit 1
          fi

      - name: Send Heartbeat Pulse
        id: pulse
        run: |
          echo "üíì Sending heartbeat pulse at $(date)"

          response=$(curl -s -w "\n%{http_code}" -X GET \
            https://bakedbot.ai/api/cron/tick \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response: $body"
          echo "http_code=$http_code" >> $GITHUB_OUTPUT
          echo "body=$body" >> $GITHUB_OUTPUT

          if [ "$http_code" != "200" ]; then
            echo "ERROR: Heartbeat failed with status $http_code"
            exit 1
          fi
        continue-on-error: true

      - name: Escalate to Linus on failure
        if: steps.pulse.outputs.http_code != '200'
        run: |
          ENDPOINT="https://bakedbot.ai/api/cron/tick"
          HTTP_CODE="${{ steps.pulse.outputs.http_code }}"
          BODY="${{ steps.pulse.outputs.body }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "üö® Heartbeat failed (HTTP $HTTP_CODE) ‚Äî escalating to Linus"

          curl -s -X POST https://bakedbot.ai/api/cron/auto-escalate \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 15 \
            -d "{
              \"type\": \"heartbeat\",
              \"data\": {
                \"httpStatus\": $HTTP_CODE,
                \"responseBody\": \"$BODY\",
                \"endpoint\": \"$ENDPOINT\",
                \"failedAt\": \"$TIMESTAMP\",
                \"githubRunUrl\": \"$RUN_URL\"
              }
            }" || echo "Warning: auto-escalate call failed (non-fatal)"

      - name: Fail job after escalation
        if: steps.pulse.outputs.http_code != '200'
        run: |
          echo "‚ùå Heartbeat failed with HTTP ${{ steps.pulse.outputs.http_code }}"
          echo "Linus has been notified. Check Slack #incidents for analysis."
          exit 1

      - name: Log Success
        if: steps.pulse.outputs.http_code == '200'
        run: echo "‚úÖ Heartbeat pulse successful - System is alive at $(date)"
