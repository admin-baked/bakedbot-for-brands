// [AI-THREAD P0-SEC-FIRESTORE-RULES]
// [Dev1-Claude @ 2025-11-29]:
//   Enhanced comprehensive Firestore security rules with role-based access control.
//   Added missing collections: brands, customers, analytics_events, chatSessions,
//   playbooks, playbookDrafts, sync_status, pricing_recommendations, retailers,
//   aiGenerations, and addresses subcollection.
//   All rules leverage Firebase custom claims (role, brandId, locationId) set during onboarding.

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Helper Functions ---
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isRole(role) {
      return request.auth.token.role == role;
    }

    function isBrandManager(brandId) {
      return isRole('brand') && request.auth.token.brandId == brandId;
    }
    
    function isDispensaryManager(locationId) {
      return isRole('dispensary') && request.auth.token.locationId == locationId;
    }

    // --- Public Collections (Read-Only) ---
    match /products/{productId} {
      // Anyone can read product details for the public menu.
      allow read: if true;
      
      // Only authenticated brand managers can create, update, or delete products
      // belonging to their own brand.
      allow create: if isBrandManager(request.resource.data.brandId);
      allow update, delete: if isBrandManager(resource.data.brandId);
    }

    match /categories/{categoryId} {
      allow read: if true;
      allow write: if false;
    }
     match /dispensaries/{dispensaryId} {
      allow read: if true;
      allow write: if false; // All location management must be done via Server Actions.
    }

    match /coupons/{couponId} {
      // Coupons are read-only from the client. Creation is handled by a secure admin action.
      allow read: if true;
      allow write: if false;
    }

    // --- User-Specific Data ---
    match /users/{userId} {
      // A user can read/update their own profile. An 'owner' can manage any user.
      allow read, update: if isOwner(userId) || isRole('owner');
      
      // Interactions are private to each user.
      match /interactions/{interactionId} {
         allow read, write: if isOwner(userId);
      }
    }
    
    // --- Sub-collections ---
    match /products/{productId} {
        // Anyone can read reviews.
        match /reviews/{reviewId} {
            allow read: if true;
            allow write: if false; // All writes via secure Server Action.
        }

        // Product feedback can only be written by a logged-in user.
        match /feedback/{userId} {
            allow read: if true;
            allow write: if isOwner(userId);
        }
        
        // Review summaries and embeddings are public-readable, but only server-writable.
        match /reviewSummaries/{docId} {
            allow read: if true;
            allow write: if false;
        }

        match /productReviewEmbeddings/{docId} {
            allow read: if true;
            allow write: if false;
        }
    }

    // This collection group query is necessary for the public "Recent Reviews" feed.
    match /{path=**}/reviews/{reviewId} {
      allow read: if true;
    }

     // This collection group query is necessary for vector search.
    match /{path=**}/productReviewEmbeddings/{docId} {
      allow read: if true;
    }
    
    // --- Orders Collection ---
    match /orders/{orderId} {
      // Allow creation through the secure server action.
      allow create: if true;

      // Read/Update access is granted based on role.
      allow read, update: if
          // The customer who placed the order.
          isOwner(resource.data.userId) ||
          // The dispensary manager fulfilling the order.
          isDispensaryManager(resource.data.retailerId) ||
          // Brand managers can view orders containing their products.
          isBrandManager(resource.data.brandId) ||
          // A global owner/admin.
          isRole('owner');
    }

    // --- Brands Collection ---
    match /brands/{brandId} {
      // Anyone can read brand profiles (for public product pages).
      allow read: if true;

      // Only brand managers can update their own brand.
      allow update: if isBrandManager(brandId);

      // Creation/deletion restricted to server actions or owner.
      allow create, delete: if isRole('owner');
    }

    // --- Customers Collection ---
    match /customers/{customerId} {
      // Customers can read/update their own profile.
      allow read, update: if isOwner(customerId);

      // Owner can access all customer profiles.
      allow read: if isRole('owner');

      // Creation happens via server actions during onboarding.
      allow create: if request.auth.uid == customerId;

      // Deletion restricted to owner or user themselves.
      allow delete: if isOwner(customerId) || isRole('owner');
    }

    // --- Analytics Events Collection ---
    match /analytics_events/{eventId} {
      // Users can create analytics events for themselves.
      allow create: if request.auth != null;

      // Only owner/admin can read analytics data.
      allow read: if isRole('owner') || isRole('brand') || isRole('dispensary');

      // No updates or deletes from client.
      allow update, delete: if false;
    }

    // --- Chat Sessions (subcollection under users) ---
    match /users/{userId}/chatSessions/{sessionId} {
      // Users can manage their own chat sessions.
      allow read, write: if isOwner(userId);

      // Owner can access all chat sessions.
      allow read: if isRole('owner');
    }

    // --- Playbooks Collection ---
    match /playbooks/{playbookId} {
      // Brand managers can read playbooks for their brand.
      allow read: if isRole('brand') || isRole('owner');

      // Only server actions can write playbooks.
      allow write: if false;
    }

    match /playbookDrafts/{draftId} {
      // Brand managers can create and manage drafts.
      allow read, write: if request.auth != null && (isRole('brand') || isRole('owner'));
    }

    // --- Sync Status Collection ---
    match /sync_status/{syncId} {
      // Allow any authenticated user to read sync status (operational logs).
      allow read: if request.auth != null;

      // Only server actions can write sync status.
      allow write: if false;
    }

    // --- Data Jobs Collection ---
    match /data_jobs/{jobId} {
      // Users can read their own data jobs.
      allow read: if resource.data.userId == request.auth.uid || isRole('owner');

      // Users can create jobs (e.g. via client components triggering them).
      allow create: if request.resource.data.userId == request.auth.uid;

      // Processing happens server-side.
      allow update, delete: if false;
    }

    // --- Pricing Recommendations Collection ---
    match /pricing_recommendations/{recId} {
      // Brand managers can read pricing recommendations.
      allow read: if isRole('brand') || isRole('owner');

      // Only server actions can write recommendations.
      allow write: if false;
    }

    // --- Retailers Collection (CannMenus sync) ---
    match /retailers/{retailerId} {
      // Anyone can read retailer info (for public locator).
      allow read: if true;

      // Only server actions can sync retailer data.
      allow write: if false;
    }

    // --- Organizations Collection ---
    match /organizations/{orgId} {
      // Members of the organization or global owners can read
      allow read: if request.auth != null; 
      allow read: if isRole('owner') || request.auth != null; // Allow any auth user to read basics for plan usage

      // Only server actions or owner can write
      allow write: if isRole('owner');
    }

    // --- AI Generations Collection ---
    match /aiGenerations/{generationId} {
      // Users can create AI generations.
      allow create: if request.auth != null;

      // Users can read their own generations, brands can read their brand's.
      allow read: if request.auth != null && (
          resource.data.userId == request.auth.uid ||
          isBrandManager(resource.data.brandId) ||
          isRole('owner')
      );

      // No client-side updates or deletes.
      allow update, delete: if false;
    }

    // --- Addresses (subcollection under users) ---
    match /users/{userId}/addresses/{addressId} {
      // Users can manage their own addresses.
      allow read, write: if isOwner(userId);

      // Owner can access all addresses.
      allow read: if isRole('owner');
    }
  }
}
