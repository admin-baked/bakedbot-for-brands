
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- Helpers ----------
    function authed() { return request.auth != null; }
    function role()    { return request.auth.token.role; }
    function isOwner() { return authed() && role() == "owner"; }
    function isDev()   { return authed() && role() == "dev"; }
    function isBrand() { return authed() && (role() == "brand" || isOwner() || isDev()); }
    function isDispensary()  { return authed() && role() == "dispensary"; }

    function userBrandId()    { return request.auth.token.brandId; }
    function userDispIds()    { return request.auth.token.dispensaryIds; }
    function canSeeBrand(bid) { return isBrand() && (userBrandId() == bid); }
    function canSeeDisp(did)  { return isDisp() && (did in userDispIds()); }

    // Convenience composition
    function brandRead(bid) { return canSeeBrand(bid) || isOwner() || isDev(); }
    function brandWrite(bid){ return canSeeBrand(bid) || isOwner() || isDev(); }

    // ---------- Public menu (anonymous read) ----------
    match /products/{productId} {
      allow read: if true;
      allow write: if false; // Managed by server actions
    }

    // Categories are public, but shouldn't be writable from the client
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if false; // Managed by backend
    }
    
    // ---------- Reviews (collection-group) ----------
    // Public read so collectionGroup("reviews") works for everyone.
    match /{path=**}/reviews/{reviewId} {
      allow get, list: if true;
      // Writes are locked to the author of the review.
      allow create: if authed() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if authed() && request.auth.uid == resource.data.userId;
    }
    
    // ---------- Interactions (collection-group) ----------
    // Brand analytics only: brand/owner/dev can read their own brandâ€™s interactions.
    match /{path=**}/interactions/{interactionId} {
      allow get, list: if request.auth != null
                      && (
                            request.auth.token.role in ["owner","dev"]
                            || (
                              request.auth.token.role == "brand"
                              && request.auth.token.brandId == resource.data.brandId
                            )
                          );
      allow create, update, delete: if request.auth != null
                                && (
                                      request.auth.token.role in ["owner","dev"]
                                      || (
                                        request.auth.token.role == "brand"
                                        && request.auth.token.brandId == resource.data.brandId
                                      )
                                    );
    }


    // ---------- Users ----------
    // Users can create their own profile.
    // They can only read/update their own profile.
    match /users/{userId} {
      allow create: if request.auth != null;
      allow read, update: if authed() && request.auth.uid == userId;
      
      // A user's own interactions are private to them.
      match /interactions/{interactionId} {
        allow read, write: if authed() && request.auth.uid == userId;
      }
    }
    
    // ---------- Orders ----------
    // Customers: can read their own orders (by uid).
    // Dispensary managers: can read any order for their dispensary(s).
    // Brand: can read orders for their brand (if brandId is on order doc).
    match /orders/{orderId} {
      allow create: if true;
      allow read: if
        // customer sees own
        (authed() && resource.data.userId == request.auth.uid)
        // dispensary manager sees orders for assigned dispensaryIds
        || (isDispensary() && canSeeDisp(resource.data.locationId))
        // brand sees its brand orders (if present)
        || (brandRead(resource.data.brandId));

      // dispensary managers update status for their dispensaries
      allow update: if isDispensary() && canSeeDisp(resource.data.locationId);

      // deletes generally restricted
      allow delete: if false;
    }

    // ---------- Brand settings / analytics ----------
    match /brands/{brandId} {
      allow get: if brandRead(brandId);
      allow update: if brandWrite(brandId);
      allow create, delete: if isOwner() || isDev();
    }

    // ---------- Dispensary locations ----------
    match /dispensaries/{dispensaryId} {
      allow get, list: if true; // basic info can be public; tighten if needed
      allow create, update, delete: if isDispensary() && canSeeDisp(dispensaryId)
                                    || isOwner() || isDev();
    }
  }
}
